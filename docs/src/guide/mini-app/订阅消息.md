# 订阅消息

订阅消息用于小程序在 **特定场景** 下向用户发送通知。开发前需要：

1. 在 **微信公众平台 → 功能 → 订阅消息** 中开启功能。
2. 从 **公共模板库** 中选择所需的消息模板并添加。

**订阅类型**

- 一次性订阅：用户点击「同意」后，只能接收 **一次消息**。
- 长期订阅：用户订阅后，可在符合规则的场景下，持续接收消息。


::: code-group

```html [wxml]
<!-- 点击按钮发起订阅请求 -->
<button bindtap="onSubscribeMessage">订阅</button>

<!-- 点击按钮触发云函数发送消息 -->
<button bindtap="onSendMessage">发送消息</button>
```

```js [js]
Page({
  // 订阅消息
  onSubscribeMessage() {
    wx.requestSubscribeMessage({
      tmplIds: [TEMPLATE_ID],
      success: (res) => {
        const result = res[TEMPLATE_ID] === 'accept';
        console.log('用户是否同意订阅：', result);
      },
      fail: (err) => {
        console.error('订阅消息失败:', err);
      }
    })
  },

  // 调用云函数发送消息
  onSendMessage() {
    this.setData({ sending: true });
    wx.cloud.callFunction({
      name: 'sendSubscribeMessage',
      success: (res) => {
        console.log('云函数发送结果:', res);
      },
      fail: (err) => {
        console.error('云函数发送失败:', err);
      },
      complete: () => {
        this.setData({ sending: false });
      }
    })
  }
})
```

```js [云函数]
const cloud = require('wx-server-sdk')

cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()

  try {
    const result = await cloud.openapi.subscribeMessage.send({
      touser: wxContext.OPENID,
      page: '/pages/index/index',
      lang: 'zh_CN',
      templateId: 'G9vEeO0X1EiiVMqwhA86YDEa1Ru0dpcGp9qtW1ZABIQ',
      miniprogramState: 'developer',
      data: {
        // 打卡内容
        thing22: { value: '运动打卡' },
        // 打开时间 (⚠️ 注意格式需为 YYYY-MM-DD HH:mm:ss 或 YYYY-MM-DD)
        time2: { value: '2025-10-03 17:20:00' },
        // 提醒内容
        thing21: { value: '请在17:00完成目标打卡' },
        // 已打卡天数
        short_thing24: { value: '3' }
      }
    })
    return { success: true, result }
  } catch (err) {
    console.error('发送订阅消息失败:', err)
    return {
      success: false,
      errorMessage: err?.message || '发送失败',
      err
    }
  }
}
```

:::
