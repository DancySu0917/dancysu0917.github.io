# 什么是作用域链？（必会）

**题目**: 什么是作用域链？（必会）

## 答案

作用域链（Scope Chain）是JavaScript中用于解析变量和标识符的机制。它决定了变量的访问权限和可见性，是JavaScript执行上下文的重要组成部分。

### 作用域链的定义

作用域链是一个由多个作用域对象组成的链式结构，当JavaScript引擎查找变量时，会按照这个链的顺序从当前作用域开始逐级向上查找，直到全局作用域。

### 作用域链的形成

作用域链的形成与函数的嵌套和调用栈密切相关：

```javascript
var globalVar = 'global';

function outer() {
    var outerVar = 'outer';
    
    function inner() {
        var innerVar = 'inner';
        console.log(globalVar); // 'global'
        console.log(outerVar);  // 'outer'
        console.log(innerVar);  // 'inner'
    }
    
    inner();
}

outer();
```

在这个例子中，`inner`函数的作用域链包含：
1. `inner`函数自身的词法环境
2. `outer`函数的词法环境
3. 全局词法环境

### 作用域链的工作原理

当JavaScript引擎查找一个变量时，会按照以下步骤进行：

1. **当前作用域查找**：首先在当前执行上下文的词法环境中查找变量
2. **逐级向上查找**：如果在当前作用域找不到，就沿着作用域链向上一级作用域查找
3. **重复查找过程**：重复步骤2，直到找到变量或到达全局作用域
4. **抛出错误**：如果在全局作用域中也找不到变量，会抛出ReferenceError

```javascript
var a = 1;

function outer() {
    var b = 2;
    
    function inner() {
        var c = 3;
        console.log(a); // 1 - 从全局作用域获取
        console.log(b); // 2 - 从outer函数作用域获取
        console.log(c); // 3 - 从当前作用域获取
    }
    
    inner();
}

outer();
```

### 作用域链与闭包的关系

闭包是作用域链的重要应用，内部函数可以访问外部函数的变量，正是因为作用域链的存在：

```javascript
function outer(x) {
    var outerVar = x;
    
    return function inner(y) {
        // inner函数可以访问outerVar，这是通过作用域链实现的
        return outerVar + y;
    };
}

var addFive = outer(5);
console.log(addFive(3)); // 8
```

在这个例子中，`inner`函数即使在`outer`函数执行完毕后，仍然可以通过作用域链访问`outerVar`变量。

### 作用域链的创建时机

作用域链在函数定义时就已经确定（词法作用域），而不是在函数调用时：

```javascript
var x = 10;

function a() {
    console.log(x); // 10
}

function b() {
    var x = 20;
    a(); // 仍然输出10，而不是20
}

b();
```

这里`a`函数定义在全局作用域中，所以它的作用域链指向全局作用域，即使在`b`函数中调用，也不会访问`b`函数中的`x`。

### 作用域链与this的区别

作用域链用于变量查找，而`this`的值取决于函数的调用方式：

```javascript
var value = 'global';

var obj = {
    value: 'object',
    
    getValue: function() {
        // 作用域链决定了value的查找路径
        console.log('value from scope chain:', value); // 'global'
        
        // this的值取决于函数的调用方式
        console.log('value from this:', this.value); // 'object'
    }
};

obj.getValue();
```

### 性能考虑

- 作用域链越长，变量查找时间可能越长
- 避免过深的嵌套，可以提高性能
- 全局变量访问比局部变量访问慢，因为需要遍历更长的作用域链

### 实际应用场景

1. **模块模式**：利用作用域链创建私有变量
2. **闭包**：内部函数访问外部函数的变量
3. **立即执行函数表达式（IIFE）**：创建独立的作用域
4. **事件处理**：在回调函数中访问外部变量

作用域链是理解JavaScript变量访问机制的关键概念，对于编写高效、可维护的代码至关重要。
