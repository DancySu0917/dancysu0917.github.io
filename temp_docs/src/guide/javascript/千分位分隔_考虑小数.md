# 千分位分隔（考虑小数）？（必会）

**题目**: 千分位分隔（考虑小数）？（必会）

## 答案

千分位分隔是将数字按照每三位添加一个分隔符（通常是逗号）的格式化方法。处理包含小数的数字时，需要特别注意只对整数部分进行千分位分隔，而不影响小数部分。

### 1. 使用原生 JavaScript 方法

#### 方法一：使用 toLocaleString()

```javascript
function formatNumber(num) {
  // 使用 toLocaleString 方法，这是最简单的方式
  return Number(num).toLocaleString('en-US');
}

// 示例
console.log(formatNumber(1234567.89)); // "1,234,567.89"
console.log(formatNumber(1234567));    // "1,234,567"
console.log(formatNumber(1234.56));    // "1,234.56"
```

### 2. 手动实现千分位分隔

#### 方法二：字符串处理

```javascript
function formatNumber(num) {
  // 转换为字符串并分离整数和小数部分
  const [integer, decimal] = String(num).split('.');
  
  // 处理整数部分的千分位分隔
  let formattedInteger = '';
  let counter = 0;
  
  // 从后往前遍历整数部分
  for (let i = integer.length - 1; i >= 0; i--) {
    if (counter > 0 && counter % 3 === 0) {
      formattedInteger = ',' + formattedInteger;
    }
    formattedInteger = integer[i] + formattedInteger;
    counter++;
  }
  
  // 如果有小数部分，拼接返回
  return decimal !== undefined ? `${formattedInteger}.${decimal}` : formattedInteger;
}

// 示例
console.log(formatNumber(1234567.89)); // "1,234,567.89"
console.log(formatNumber(1234567));    // "1,234,567"
console.log(formatNumber(1234.56));    // "1,234.56"
```

#### 方法三：使用正则表达式

```javascript
function formatNumber(num) {
  // 将数字转换为字符串
  const numStr = String(num);
  
  // 使用正则表达式匹配整数部分并添加千分位分隔符
  return numStr.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// 示例
console.log(formatNumber(1234567.89)); // "1,234,567.89"
console.log(formatNumber(1234567));    // "1,234,567"
console.log(formatNumber(1234.56));    // "1,234.56"
```

### 3. 完整的千分位分隔函数实现

```javascript
function formatNumber(num, separator = ',') {
  // 处理非数字输入
  if (typeof num !== 'number' && typeof num !== 'string') {
    throw new Error('Input must be a number or string');
  }
  
  // 转换为字符串
  const numStr = String(num);
  
  // 分离符号、整数部分和小数部分
  const match = numStr.match(/^(-?)(\d+)(\.(\d+))?$/);
  
  if (!match) {
    throw new Error('Invalid number format');
  }
  
  const [, sign, integer, , decimal] = match;
  
  // 对整数部分进行千分位分隔
  const formattedInteger = integer.replace(/\B(?=(\d{3})+(?!\d))/g, separator);
  
  // 拼接结果
  let result = sign + formattedInteger;
  if (decimal !== undefined) {
    result += '.' + decimal;
  }
  
  return result;
}

// 示例
console.log(formatNumber(1234567.89));  // "1,234,567.89"
console.log(formatNumber(-1234567.89)); // "-1,234,567.89"
console.log(formatNumber(1234567));     // "1,234,567"
console.log(formatNumber(1234.56));     // "1,234.56"
console.log(formatNumber(123, '.'));    // "123" (小数字不加分隔符)
```

### 4. 处理边界情况

```javascript
function formatNumber(num) {
  // 处理特殊值
  if (isNaN(num) || num === null || num === undefined) {
    return '0';
  }
  
  // 转换为数字并处理
  const number = Number(num);
  
  // 使用 toLocaleString 处理千分位分隔
  return number.toLocaleString('en-US', {
    maximumFractionDigits: 20 // 保留足够多的小数位数
  });
}

// 边界情况测试
console.log(formatNumber('1234567.890000')); // "1,234,567.89"
console.log(formatNumber(0));                // "0"
console.log(formatNumber(123));              // "123"
console.log(formatNumber(1234));             // "1,234"
console.log(formatNumber('1234567'));        // "1,234,567"
console.log(formatNumber('-1234567.89'));   // "-1,234,567.89"
```

### 5. 高级实现（支持自定义分隔符和精度）

```javascript
function formatNumber(num, options = {}) {
  const {
    separator = ',',      // 千分位分隔符
    decimalSeparator = '.', // 小数点分隔符
    precision = null      // 小数精度，null 表示不限制
  } = options;
  
  if (typeof num !== 'number' && typeof num !== 'string') {
    return '0';
  }
  
  let number = Number(num);
  if (isNaN(number)) {
    return '0';
  }
  
  // 如果指定了精度，先进行四舍五入
  if (precision !== null) {
    number = parseFloat(number.toFixed(precision));
  }
  
  // 转换为字符串并分离整数和小数部分
  const numStr = String(number);
  const [integerPart, decimalPart] = numStr.split('.');
  
  // 格式化整数部分
  const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, separator);
  
  // 拼接结果
  if (decimalPart !== undefined) {
    return `${formattedInteger}${decimalSeparator}${decimalPart}`;
  } else {
    return formattedInteger;
  }
}

// 使用示例
console.log(formatNumber(1234567.89123, { precision: 2 })); // "1,234,567.89"
console.log(formatNumber(1234567.89, { separator: ' ' }));  // "1 234 567.89"
console.log(formatNumber(1234567.89, { 
  separator: '.', 
  decimalSeparator: ',' 
})); // "1.234.567,89" (欧洲格式)
```

### 6. 总结

千分位分隔的关键点：
1. 只对整数部分进行分隔，不影响小数部分
2. 从右往左每三位添加一个分隔符
3. 处理负数情况
4. 考虑各种边界情况（如小数、负数、特殊值等）
5. 可以使用原生的 toLocaleString 方法或手动实现

这些方法可以根据具体需求选择使用，`toLocaleString` 是最简单的方式，而手动实现则提供了更大的灵活性。
