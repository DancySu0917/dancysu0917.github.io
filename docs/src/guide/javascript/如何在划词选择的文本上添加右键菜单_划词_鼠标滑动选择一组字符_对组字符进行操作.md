# 如何在划词选择的文本上添加右键菜单（划词：鼠标滑动选择一组字符，对组字符进行操作）？（了解）

**题目**: 如何在划词选择的文本上添加右键菜单（划词：鼠标滑动选择一组字符，对组字符进行操作）？（了解）

## 标准答案

在划词选择的文本上添加右键菜单需要结合Selection API获取选中文本和自定义右键菜单实现。主要步骤包括：1) 监听鼠标右键事件；2) 使用getSelection()获取选中文本；3) 阻止默认右键菜单；4) 显示自定义菜单；5) 处理菜单项点击事件。核心是利用window.getSelection()或document.getSelection()获取选中内容，结合position定位自定义菜单到鼠标位置。

## 详细解析

### 核心概念与实现原理

划词选择并添加右键菜单功能涉及多个核心概念：

1. **Selection API**: 用于获取用户选中的文本内容和位置信息
2. **鼠标事件处理**: 监听右键点击事件并阻止默认行为
3. **自定义菜单**: 创建可交互的UI组件来替代默认右键菜单
4. **文本操作**: 对选中文本进行各种处理操作

### 完整实现方案

```javascript
// 自定义划词右键菜单类
class TextSelectionContextMenu {
    constructor(options = {}) {
        this.options = {
            menuItems: options.menuItems || [
                { label: '复制', action: 'copy' },
                { label: '翻译', action: 'translate' },
                { label: '收藏', action: 'favorite' },
                { label: '分享', action: 'share' }
            ],
            menuClass: options.menuClass || 'text-selection-menu',
            ...options
        };
        
        this.menuElement = null;
        this.selectedText = '';
        this.clientX = 0;
        this.clientY = 0;
        
        this.init();
    }
    
    init() {
        this.createMenu();
        this.bindEvents();
    }
    
    createMenu() {
        // 创建菜单容器
        this.menuElement = document.createElement('div');
        this.menuElement.className = this.options.menuClass;
        this.menuElement.style.cssText = `
            position: fixed;
            display: none;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10000;
            min-width: 120px;
            padding: 4px 0;
        `;
        
        // 添加菜单项
        this.options.menuItems.forEach(item => {
            const menuItem = document.createElement('div');
            menuItem.className = 'menu-item';
            menuItem.textContent = item.label;
            menuItem.style.cssText = `
                padding: 8px 12px;
                cursor: pointer;
                user-select: none;
            `;
            
            menuItem.addEventListener('click', () => {
                this.handleMenuItemClick(item);
                this.hideMenu();
            });
            
            menuItem.addEventListener('mouseenter', () => {
                menuItem.style.backgroundColor = '#f5f5f5';
            });
            
            menuItem.addEventListener('mouseleave', () => {
                menuItem.style.backgroundColor = 'transparent';
            });
            
            this.menuElement.appendChild(menuItem);
        });
        
        document.body.appendChild(this.menuElement);
    }
    
    bindEvents() {
        // 监听右键事件
        document.addEventListener('contextmenu', (e) => {
            this.handleContextMenu(e);
        });
        
        // 点击其他地方隐藏菜单
        document.addEventListener('click', () => {
            this.hideMenu();
        });
        
        // 按ESC键隐藏菜单
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.hideMenu();
            }
        });
    }
    
    handleContextMenu(e) {
        // 获取选中文本
        const selection = window.getSelection();
        this.selectedText = selection.toString().trim();
        
        // 如果没有选中文本，不显示自定义菜单
        if (!this.selectedText) {
            return;
        }
        
        // 阻止默认右键菜单
        e.preventDefault();
        
        // 记录鼠标位置
        this.clientX = e.clientX;
        this.clientY = e.clientY;
        
        // 显示自定义菜单
        this.showMenu();
    }
    
    showMenu() {
        // 设置菜单位置
        this.menuElement.style.left = this.clientX + 'px';
        this.menuElement.style.top = this.clientY + 'px';
        this.menuElement.style.display = 'block';
    }
    
    hideMenu() {
        this.menuElement.style.display = 'none';
    }
    
    handleMenuItemClick(menuItem) {
        // 根据菜单项执行相应操作
        switch (menuItem.action) {
            case 'copy':
                this.copySelectedText();
                break;
            case 'translate':
                this.translateSelectedText();
                break;
            case 'favorite':
                this.favoriteSelectedText();
                break;
            case 'share':
                this.shareSelectedText();
                break;
            default:
                if (typeof menuItem.action === 'function') {
                    menuItem.action(this.selectedText, { x: this.clientX, y: this.clientY });
                }
                break;
        }
    }
    
    // 复制选中文本
    async copySelectedText() {
        try {
            await navigator.clipboard.writeText(this.selectedText);
            this.showNotification('文本已复制到剪贴板');
        } catch (err) {
            // 降级方案：使用execCommand
            const textArea = document.createElement('textarea');
            textArea.value = this.selectedText;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            this.showNotification('文本已复制到剪贴板');
        }
    }
    
    // 翻译选中文本
    translateSelectedText() {
        // 这里可以集成翻译API
        const translationUrl = `https://translate.google.com/#view=home&op=translate&sl=auto&tl=zh&text=${encodeURIComponent(this.selectedText)}`;
        window.open(translationUrl, '_blank');
    }
    
    // 收藏选中文本
    favoriteSelectedText() {
        // 将选中文本保存到本地存储
        const favorites = JSON.parse(localStorage.getItem('textFavorites') || '[]');
        const favoriteItem = {
            text: this.selectedText,
            timestamp: Date.now(),
            url: window.location.href
        };
        
        favorites.push(favoriteItem);
        localStorage.setItem('textFavorites', JSON.stringify(favorites));
        
        this.showNotification('文本已收藏');
    }
    
    // 分享选中文本
    shareSelectedText() {
        if (navigator.share) {
            navigator.share({
                title: '分享文本',
                text: this.selectedText,
                url: window.location.href
            }).catch(err => {
                console.log('分享失败:', err);
            });
        } else {
            // 降级方案：复制链接
            const shareText = `${this.selectedText} - 来源: ${window.location.href}`;
            navigator.clipboard.writeText(shareText);
            this.showNotification('分享链接已复制');
        }
    }
    
    showNotification(message) {
        // 简单的通知显示
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            z-index: 10001;
            font-size: 14px;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 3000);
    }
}

// 使用示例
document.addEventListener('DOMContentLoaded', () => {
    const contextMenu = new TextSelectionContextMenu({
        menuItems: [
            { label: '复制', action: 'copy' },
            { label: '翻译', action: 'translate' },
            { label: '收藏', action: 'favorite' },
            { label: '分享', action: 'share' },
            { 
                label: '自定义操作', 
                action: (selectedText, position) => {
                    console.log('自定义操作:', selectedText, position);
                } 
            }
        ]
    });
});
```

### 高级功能实现

```javascript
// 增强版划词右键菜单，支持更多功能
class AdvancedTextSelectionContextMenu extends TextSelectionContextMenu {
    constructor(options = {}) {
        super(options);
        
        // 选中文本的额外信息
        this.selectionRange = null;
        this.selectionRect = null;
        
        // 添加额外功能
        this.initAdvancedFeatures();
    }
    
    initAdvancedFeatures() {
        // 监听选择事件以获取更精确的选中信息
        document.addEventListener('selectionchange', () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                this.selectionRange = selection.getRangeAt(0);
                this.selectionRect = this.selectionRange.getBoundingClientRect();
            }
        });
        
        // 添加快捷键支持
        this.addKeyboardShortcuts();
    }
    
    addKeyboardShortcuts() {
        // 为菜单添加快捷键支持
        this.menuElement.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    this.focusNextMenuItem();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    this.focusPreviousMenuItem();
                    break;
                case 'Enter':
                case ' ':
                    e.preventDefault();
                    this.clickFocusedMenuItem();
                    break;
            }
        });
    }
    
    focusNextMenuItem() {
        const items = this.menuElement.querySelectorAll('.menu-item');
        const focused = document.activeElement;
        const currentIndex = Array.from(items).indexOf(focused);
        
        if (currentIndex < items.length - 1) {
            items[currentIndex + 1].focus();
        } else {
            items[0].focus();
        }
    }
    
    focusPreviousMenuItem() {
        const items = this.menuElement.querySelectorAll('.menu-item');
        const focused = document.activeElement;
        const currentIndex = Array.from(items).indexOf(focused);
        
        if (currentIndex > 0) {
            items[currentIndex - 1].focus();
        } else {
            items[items.length - 1].focus();
        }
    }
    
    clickFocusedMenuItem() {
        const focused = document.activeElement;
        if (focused && focused.classList.contains('menu-item')) {
            focused.click();
        }
    }
    
    // 获取选中文本的上下文信息
    getSelectionContext() {
        const selection = window.getSelection();
        if (selection.rangeCount === 0) return null;
        
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;
        
        return {
            text: selection.toString(),
            range: range,
            container: container,
            rect: this.selectionRect,
            startOffset: range.startOffset,
            endOffset: range.endOffset
        };
    }
    
    // 扩展菜单项
    extendMenuItems() {
        // 可以根据选中文本的内容动态添加菜单项
        const context = this.getSelectionContext();
        if (!context || !context.text) return [];
        
        const extendedItems = [];
        
        // 如果选中的是链接，添加"打开链接"选项
        if (/^https?:\/\/[^\s]+$/.test(context.text.trim())) {
            extendedItems.push({ label: '打开链接', action: 'openLink' });
        }
        
        // 如果选中的是邮箱，添加"发送邮件"选项
        if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(context.text.trim())) {
            extendedItems.push({ label: '发送邮件', action: 'sendEmail' });
        }
        
        return extendedItems;
    }
    
    // 处理扩展菜单项
    handleExtendedMenuItem(menuItem) {
        switch (menuItem.action) {
            case 'openLink':
                window.open(this.selectedText, '_blank');
                break;
            case 'sendEmail':
                window.location.href = `mailto:${this.selectedText}`;
                break;
        }
    }
}

// 富文本编辑器中的划词菜单实现
class RichTextEditorContextMenu {
    constructor(editorElement) {
        this.editor = editorElement;
        this.menu = null;
        this.init();
    }
    
    init() {
        this.createMenu();
        this.bindEvents();
    }
    
    createMenu() {
        this.menu = document.createElement('div');
        this.menu.className = 'rich-text-menu';
        this.menu.style.cssText = `
            position: fixed;
            display: none;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10000;
            min-width: 150px;
        `;
        
        // 添加富文本编辑功能
        const menuItems = [
            { label: '加粗', command: 'bold' },
            { label: '斜体', command: 'italic' },
            { label: '下划线', command: 'underline' },
            { label: '链接', command: 'createLink' },
            { label: '删除线', command: 'strikeThrough' }
        ];
        
        menuItems.forEach(item => {
            const menuItem = document.createElement('div');
            menuItem.className = 'menu-item';
            menuItem.textContent = item.label;
            menuItem.style.cssText = `
                padding: 8px 12px;
                cursor: pointer;
            `;
            
            menuItem.addEventListener('click', () => {
                this.executeCommand(item.command);
                this.hideMenu();
            });
            
            this.menu.appendChild(menuItem);
        });
        
        document.body.appendChild(this.menu);
    }
    
    bindEvents() {
        this.editor.addEventListener('contextmenu', (e) => {
            const selection = window.getSelection();
            if (selection.toString().trim()) {
                e.preventDefault();
                this.showMenu(e.clientX, e.clientY);
            }
        });
        
        document.addEventListener('click', () => {
            this.hideMenu();
        });
    }
    
    showMenu(x, y) {
        this.menu.style.left = x + 'px';
        this.menu.style.top = y + 'px';
        this.menu.style.display = 'block';
    }
    
    hideMenu() {
        this.menu.style.display = 'none';
    }
    
    executeCommand(command) {
        if (command === 'createLink') {
            const url = prompt('请输入链接地址:');
            if (url) {
                document.execCommand(command, false, url);
            }
        } else {
            document.execCommand(command, false, null);
        }
    }
}
```

### 实际应用场景

1. **在线阅读平台**：用户可以选择文本进行翻译、收藏、分享
2. **文档编辑器**：提供快速格式化选项，如加粗、斜体、链接等
3. **学习工具**：划词查词、添加笔记、创建闪卡
4. **内容管理系统**：快速编辑和操作选中文本

### 注意事项

1. **性能优化**：避免频繁监听选择事件，使用防抖处理
2. **兼容性处理**：不同浏览器的Selection API支持可能有差异
3. **用户体验**：确保菜单响应快速，操作流畅
4. **安全考虑**：对用户输入进行适当的验证和清理
5. **可访问性**：支持键盘导航和屏幕阅读器
