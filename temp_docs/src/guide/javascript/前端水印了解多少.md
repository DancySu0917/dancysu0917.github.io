# 前端水印了解多少？（了解）

**题目**: 前端水印了解多少？（了解）

## 前端水印概述

前端水印是一种在网页或图片上添加标识的技术，主要用于版权保护、防截图、防录屏、数据泄露防护等场景。前端水印可以在不影响用户体验的情况下，对敏感内容进行标识。

## 水印类型

### 1. 图片水印
- **背景水印**：将水印作为背景图应用到页面元素上
- **叠加水印**：在图片上叠加半透明水印

### 2. 文字水印
- **CSS水印**：使用CSS样式实现的水印
- **Canvas水印**：使用Canvas绘制的水印

### 3. DOM水印
- **元素水印**：通过创建DOM元素实现的水印

## 实现方式

### 1. CSS背景水印

```css
.watermark-bg {
  background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEwAACxMBAJqcGAAAAF1JREFUeJzt00EJwDAQA8FQ/56iKOhp0MhJ8Jp1k8n4Zo8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIDv7bNnZl+X9v25AAAAAElFTkSuQmCC');
  background-repeat: repeat;
  background-size: 200px 100px;
  opacity: 0.1;
}
```

### 2. Canvas绘制水印

```javascript
function createWatermarkCanvas(text, width = 200, height = 100) {
  const canvas = document.createElement('canvas');
  canvas.width = width;
  canvas.height = height;
  
  const ctx = canvas.getContext('2d');
  ctx.rotate(-20 * Math.PI / 180);
  ctx.font = '14px Arial';
  ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
  ctx.textAlign = 'center';
  ctx.fillText(text, width / 2, height / 2);
  
  return canvas.toDataURL();
}

// 应用到页面
function addWatermark(text, container = document.body) {
  const watermarkUrl = createWatermarkCanvas(text);
  container.style.backgroundImage = `url('${watermarkUrl}')`;
  container.style.backgroundRepeat = 'repeat';
}
```

### 3. DOM水印（动态）

```javascript
class Watermark {
  constructor(options = {}) {
    this.text = options.text || 'CONFIDENTIAL';
    this.fontSize = options.fontSize || '16px';
    this.color = options.color || 'rgba(0, 0, 0, 0.1)';
    this.angle = options.angle || -20;
    this.width = options.width || 200;
    this.height = options.height || 150;
    this.container = options.container || document.body;
    
    this.createWatermark();
  }
  
  createWatermark() {
    // 创建水印容器
    this.watermarkDiv = document.createElement('div');
    this.watermarkDiv.style.position = 'fixed';
    this.watermarkDiv.style.top = '0';
    this.watermarkDiv.style.left = '0';
    this.watermarkDiv.style.width = '100%';
    this.watermarkDiv.style.height = '100%';
    this.watermarkDiv.style.pointerEvents = 'none';
    this.watermarkDiv.style.zIndex = '9999';
    this.watermarkDiv.style.backgroundImage = `url("${this.generateWatermarkImage()}")`;
    this.watermarkDiv.style.backgroundRepeat = 'repeat';
    
    // 防止被删除
    this.watermarkDiv.addEventListener('DOMNodeRemoved', (e) => {
      if (e.target === this.watermarkDiv) {
        setTimeout(() => {
          this.container.appendChild(this.watermarkDiv);
        }, 0);
      }
    });
    
    this.container.appendChild(this.watermarkDiv);
  }
  
  generateWatermarkImage() {
    const canvas = document.createElement('canvas');
    canvas.width = this.width;
    canvas.height = this.height;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 设置旋转和样式
    ctx.save();
    ctx.translate(this.width / 2, this.height / 2);
    ctx.rotate(this.angle * Math.PI / 180);
    ctx.fillStyle = this.color;
    ctx.font = `${this.fontSize} Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(this.text, 0, 0);
    ctx.restore();
    
    return canvas.toDataURL();
  }
  
  destroy() {
    if (this.watermarkDiv && this.watermarkDiv.parentNode) {
      this.watermarkDiv.parentNode.removeChild(this.watermarkDiv);
    }
  }
}

// 使用示例
const watermark = new Watermark({
  text: '内部资料 严禁外传',
  fontSize: '18px',
  color: 'rgba(255, 0, 0, 0.08)',
  container: document.body
});
```

### 4. 高级水印（防篡改）

```javascript
class AdvancedWatermark {
  constructor(options = {}) {
    this.text = options.text || 'CONFIDENTIAL';
    this.userInfo = options.userInfo || 'user@example.com';
    this.timestamp = options.timestamp || new Date().toISOString();
    this.container = options.container || document.body;
    this.interval = null;
    
    this.init();
  }
  
  init() {
    this.createWatermark();
    this.startMonitoring();
  }
  
  createWatermark() {
    // 创建包含用户信息的水印
    const watermarkContent = `${this.text}\n${this.userInfo}\n${this.timestamp}`;
    
    const canvas = document.createElement('canvas');
    canvas.width = 300;
    canvas.height = 200;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.rotate(-20 * Math.PI / 180);
    ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // 绘制多行文本
    const lines = watermarkContent.split('\n');
    lines.forEach((line, index) => {
      ctx.fillText(line, 0, (index - (lines.length - 1) / 2) * 20);
    });
    
    ctx.restore();
    
    // 创建水印元素
    this.watermarkDiv = document.createElement('div');
    this.watermarkDiv.style.position = 'fixed';
    this.watermarkDiv.style.top = '0';
    this.watermarkDiv.style.left = '0';
    this.watermarkDiv.style.width = '100%';
    this.watermarkDiv.style.height = '100%';
    this.watermarkDiv.style.pointerEvents = 'none';
    this.watermarkDiv.style.zIndex = '9999';
    this.watermarkDiv.style.backgroundImage = `url("${canvas.toDataURL()}")`;
    this.watermarkDiv.style.backgroundRepeat = 'repeat';
    
    // 添加MutationObserver防止被删除
    this.setupObserver();
    
    this.container.appendChild(this.watermarkDiv);
  }
  
  setupObserver() {
    this.observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.removedNodes.forEach((node) => {
          if (node === this.watermarkDiv) {
            // 如果水印被删除，重新添加
            console.warn('Watermark was removed, adding it back');
            this.container.appendChild(this.watermarkDiv);
          }
        });
      });
    });
    
    this.observer.observe(this.container, {
      childList: true,
      subtree: true
    });
  }
  
  startMonitoring() {
    // 定期检查水印是否存在
    this.interval = setInterval(() => {
      if (!this.watermarkDiv.parentNode) {
        this.container.appendChild(this.watermarkDiv);
      }
    }, 1000);
  }
  
  destroy() {
    if (this.interval) {
      clearInterval(this.interval);
    }
    
    if (this.observer) {
      this.observer.disconnect();
    }
    
    if (this.watermarkDiv && this.watermarkDiv.parentNode) {
      this.watermarkDiv.parentNode.removeChild(this.watermarkDiv);
    }
  }
}
```

## 防护措施

### 1. 防止删除
- 使用MutationObserver监控DOM变化
- 定期检查水印元素是否存在
- 防止右键菜单删除

### 2. 防止样式修改
- 监控CSS样式变化
- 重置被修改的样式

### 3. 防止截图
- 结合后端验证
- 添加时间戳信息

## 应用场景

1. **文档保护**：PDF预览、在线文档
2. **图片保护**：图片库、摄影作品
3. **数据防泄漏**：企业内部系统
4. **版权保护**：内容平台

## 优缺点

### 优点
- 实现简单
- 不影响用户体验
- 服务端压力小
- 可以包含动态信息

### 缺点
- 容易被有经验的用户移除
- 无法完全防止截图
- 可能影响页面性能

## 最佳实践

1. **结合后端验证**：前端水印作为辅助，后端验证作为主要手段
2. **合理使用**：在必要场景使用，避免过度使用影响体验
3. **性能考虑**：避免过于频繁的监控和重绘
4. **用户体验**：保持水印透明度适中，不影响正常阅读

前端水印是数据安全防护的重要手段之一，虽然不能完全防止数据泄露，但可以起到很好的威慑和追踪作用。
