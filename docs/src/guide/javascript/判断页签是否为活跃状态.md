# 判断页签是否为活跃状态？（了解）

**题目**: 判断页签是否为活跃状态？（了解）

在前端开发中，判断页签（Tab）是否为活跃状态是一个常见需求，特别是在需要优化性能、控制资源使用或进行数据分析时。以下是几种判断页签是否活跃的方法：

## 1. 使用 Page Visibility API

Page Visibility API 是最常用和推荐的方法，可以检测页面是否可见以及是否为活跃状态。

```javascript
// 检测页面可见性变化
document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    console.log('页面不可见（页签非活跃）');
    // 暂停动画、轮询等操作
  } else {
    console.log('页面可见（页签活跃）');
    // 恢复动画、轮询等操作
  }
});

// 当前页面是否可见
function isTabActive() {
  return !document.hidden;
}

// 使用示例
if (isTabActive()) {
  console.log('当前页签处于活跃状态');
} else {
  console.log('当前页签处于非活跃状态');
}
```

## 2. 检测页面焦点状态

通过监听 `focus` 和 `blur` 事件可以判断用户是否切换到当前页签：

```javascript
let isActive = true;

window.addEventListener('focus', function() {
  isActive = true;
  console.log('页签获得焦点，处于活跃状态');
});

window.addEventListener('blur', function() {
  isActive = false;
  console.log('页签失去焦点，处于非活跃状态');
});

// 检查当前页签是否聚焦
function isTabFocused() {
  return isActive && document.hasFocus();
}
```

## 3. 结合多种方法的完整实现

```javascript
class TabVisibilityManager {
  constructor() {
    this.isActive = true;
    this.visibilityState = 'visible';
    this.callbacks = {
      active: [],
      inactive: []
    };
    
    this.init();
  }
  
  init() {
    // 监听页面可见性变化
    document.addEventListener('visibilitychange', () => {
      this.visibilityState = document.visibilityState;
      this.isActive = !document.hidden;
      this.handleStateChange();
    });
    
    // 监听页面焦点变化
    window.addEventListener('focus', () => {
      this.isActive = true;
      this.handleStateChange();
    });
    
    window.addEventListener('blur', () => {
      this.isActive = false;
      this.handleStateChange();
    });
  }
  
  handleStateChange() {
    if (this.isActive) {
      this.callbacks.active.forEach(callback => callback());
    } else {
      this.callbacks.inactive.forEach(callback => callback());
    }
  }
  
  onActive(callback) {
    this.callbacks.active.push(callback);
  }
  
  onInactive(callback) {
    this.callbacks.inactive.push(callback);
  }
  
  isTabActive() {
    return this.isActive && document.visibilityState === 'visible';
  }
}

// 使用示例
const tabManager = new TabVisibilityManager();

tabManager.onActive(() => {
  console.log('页签变为活跃状态');
  // 恢复定时器、轮询等操作
});

tabManager.onInactive(() => {
  console.log('页签变为非活跃状态');
  // 暂停定时器、轮询等操作
});

// 检查当前页签状态
console.log('当前页签是否活跃:', tabManager.isTabActive());
```

## 4. 实际应用场景

### 1. 优化定时器和轮询
```javascript
let pollInterval;

function startPolling() {
  pollInterval = setInterval(() => {
    // 执行轮询操作
    fetch('/api/data').then(response => response.json())
      .then(data => updateUI(data));
  }, 5000);
}

function stopPolling() {
  if (pollInterval) {
    clearInterval(pollInterval);
  }
}

// 根据页签状态控制轮询
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    stopPolling(); // 页签不活跃时停止轮询
  } else {
    startPolling(); // 页签活跃时开始轮询
  }
});
```

### 2. 暂停/恢复动画
```javascript
let animationFrame;

function animate() {
  // 动画逻辑
  if (!document.hidden) {
    animationFrame = requestAnimationFrame(animate);
  }
}

// 开始动画
animate();

// 页面可见性变化时控制动画
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    cancelAnimationFrame(animationFrame); // 暂停动画
  } else {
    animate(); // 恢复动画
  }
});
```

## 5. 注意事项

1. **兼容性**: Page Visibility API 在现代浏览器中支持良好，但在老版本 IE 中可能不支持
2. **准确度**: `visibilitychange` 事件更准确地反映页面是否可见，而 `focus/blur` 仅反映窗口焦点
3. **性能**: 在页签非活跃时暂停不必要的操作可以节省 CPU 和电池资源
4. **用户体验**: 合理使用页签状态检测可以提升用户体验，避免后台页签消耗过多资源

通过这些方法，我们可以准确判断页签的活跃状态，并根据状态优化应用性能。
