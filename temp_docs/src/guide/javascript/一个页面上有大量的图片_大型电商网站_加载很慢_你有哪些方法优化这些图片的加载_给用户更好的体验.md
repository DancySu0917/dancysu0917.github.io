# 一个页面上有大量的图片（大型电商网站），加载很慢，你有哪些方法优化这些图片的加载，给用户更好的体验？（必会）

**题目**: 一个页面上有大量的图片（大型电商网站），加载很慢，你有哪些方法优化这些图片的加载，给用户更好的体验？（必会）

## 图片加载优化策略

### 1. 图片懒加载（Lazy Loading）

只在图片即将进入视口时才加载图片，减少初始加载时间。

```javascript
// 使用Intersection Observer API实现懒加载
const imageObserver = new IntersectionObserver((entries, observer) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const img = entry.target;
      img.src = img.dataset.src; // 将data-src的值赋给src
      img.classList.remove('lazy');
      observer.unobserve(img);
    }
  });
});

document.querySelectorAll('img[data-src]').forEach(img => {
  imageObserver.observe(img);
});
```

### 2. 图片预加载（Preloading）

对关键图片进行预加载，提升用户体验。

```javascript
function preloadImage(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = url;
  });
}
```

### 3. 图片压缩与格式优化

- **使用现代图片格式**：WebP、AVIF等格式提供更好的压缩率
- **响应式图片**：根据设备屏幕大小提供不同尺寸的图片
- **压缩图片**：在保证质量的前提下减少文件大小

```html
<picture>
  <source srcset="image.webp" type="image/webp">
  <source srcset="image.avif" type="image/avif">
  <img src="image.jpg" alt="描述">
</picture>

<!-- 响应式图片 -->
<img srcset="small.jpg 480w, medium.jpg 800w, large.jpg 1200w"
     sizes="(max-width: 480px) 100vw, (max-width: 800px) 50vw, 33vw"
     src="medium.jpg" alt="描述">
```

### 4. CDN加速

使用CDN分发图片资源，减少网络延迟。

### 5. 图片尺寸优化

- **服务端动态裁剪**：根据需要返回合适尺寸的图片
- **避免大图小用**：确保图片尺寸与显示尺寸匹配

### 6. 使用占位符

- **低质量图片占位符（LQIP）**：先加载低质量图片，再替换为高质量图片
- **彩色占位符**：使用图片的主色调作为占位符

```css
.image-placeholder {
  background-color: #f0f0f0;
  background-image: url('low-quality-preview.jpg');
  background-size: cover;
}
```

### 7. 缓存策略

- **设置合适的HTTP缓存头**：利用浏览器缓存
- **Service Worker缓存**：对图片进行离线缓存

### 8. 图片加载错误处理

```javascript
function handleImageError(img) {
  img.src = 'placeholder-image.png';
  img.alt = '图片加载失败';
}
```

### 9. 虚拟滚动

对于大量图片列表，只渲染视口内的图片。

### 10. 预加载策略

- **预加载可视区域外的图片**：提前加载用户可能看到的图片
- **根据用户行为预测**：根据用户浏览习惯预加载可能需要的图片

### 11. 压缩与优化工具

- **构建时优化**：使用webpack、vite等工具的图片优化插件
- **在线压缩工具**：TinyPNG、Squoosh等

### 12. 实施建议

1. **优先级排序**：先加载首屏关键图片
2. **监控性能**：使用Lighthouse、Web Vitals等工具监控图片加载性能
3. **渐进式增强**：在支持的浏览器中使用新特性，不支持的降级处理

### 实际应用示例

```html
<!-- 使用loading="lazy"属性（现代浏览器支持） -->
<img src="image.jpg" alt="描述" loading="lazy" width="300" height="200">
```

```css
/* 使用CSS实现渐进式加载效果 */
.progressive-image {
  position: relative;
  background-size: cover;
  background-position: center;
}

.progressive-image::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: var(--low-quality-src);
  filter: blur(5px);
  z-index: -1;
}
```

通过综合运用这些优化策略，可以显著提升大量图片的加载速度和用户体验，特别是在大型电商网站等图片密集型应用中。
